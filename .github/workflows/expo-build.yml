name: Expo Build Check

on:
  push:
    branches: [ main ]
    paths:
      - 'package.json'
      - 'app.json'
      - 'src/**'
      - 'App.tsx'
  pull_request:
    branches: [ main ]
    paths:
      - 'package.json'
      - 'app.json'
      - 'src/**'
      - 'App.tsx'
  workflow_dispatch:

jobs:
  expo-doctor:
    name: Expo Doctor Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Run Expo Doctor
        run: npx expo-doctor || true

      - name: Check Expo config
        run: npx expo config --type public

  build-preview:
    name: Build Preview (Development)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Create development build manifest
        run: |
          echo "Creating development build manifest..."
          npx expo export --platform all --dev || echo "Export completed with warnings"

      - name: Comment build info on PR
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = `
            ## ðŸ“± Expo Build Preview

            **Status**: Build manifest created successfully
            **Platform**: iOS & Android
            **Mode**: Development

            To test this PR:
            1. Install Expo Go on your device
            2. Checkout this branch: \`git checkout ${{ github.head_ref }}\`
            3. Run: \`npm install && npm start\`
            4. Scan the QR code with Expo Go

            ---
            *Generated by GitHub Actions*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
